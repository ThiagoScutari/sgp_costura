<!DOCTYPE html>
<html lang="pt-br" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGP Costura - Cockpit VAC v7 (Final)</title>

    <!-- Unified Theme & Layout -->
    <link rel="stylesheet" href="../shared/theme.css">
    <script src="../shared/auth.js"></script>
    <script src="../shared/layout.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;700&display=swap"
        rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .kanban-column {
            min-width: 280px;
            flex: 1;
        }

        .border-reta {
            border-left: 6px solid #2196F3 !important;
        }

        .border-over {
            border-left: 6px solid #9C27B0 !important;
        }

        .border-cobertura {
            border-left: 6px solid #FF9800 !important;
        }

        .border-catraca {
            border-left: 6px solid #795548 !important;
        }

        .border-manual {
            border-left: 6px solid #64748b !important;
        }

        /* Destaque para cards fracionados (Original e Fra√ß√£o) */
        .op-fraction {
            border-left: 6px dashed #94a3b8 !important;
            background-color: #1e293b !important;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .sortable-ghost {
            opacity: 0.3;
            background: #359EFF !important;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #2d3748;
            border-radius: 10px;
        }

        #fraction-modal {
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="bg-[#0f1923] text-gray-200 h-screen overflow-hidden flex flex-col">

    <!-- Version Management Modal -->
    <div id="version-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 p-4"
        style="backdrop-filter: blur(4px);">
        <div class="bg-[#1b2227] border border-gray-700 w-full max-w-3xl rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h3 class="text-white font-black uppercase tracking-tight flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-400">cloud_upload</span>
                    Publicar Balanceamento
                </h3>
                <button onclick="closeVersionModal()" class="text-gray-500 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <h4 class="text-sm font-bold text-gray-400 uppercase mb-2">Vers√µes Existentes:</h4>
                    <div id="existing-versions" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                        <!-- Versions will be loaded here -->
                    </div>
                </div>
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                    <p class="text-xs text-blue-400 font-bold mb-3 uppercase">Nova Vers√£o</p>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400 font-bold uppercase block mb-2">Nome da Vers√£o
                                (opcional)</label>
                            <input type="text" id="version-name" placeholder="Ex: Balanceamento Otimizado v2"
                                class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-blue-500 text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 font-bold uppercase block mb-2">Observa√ß√µes
                                (opcional)</label>
                            <textarea id="version-notes" placeholder="Descreva as mudan√ßas ou melhorias..." rows="3"
                                class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-blue-500 text-sm resize-none"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-gray-800/30 flex gap-3">
                <button onclick="closeVersionModal()"
                    class="flex-1 py-3 text-xs font-black text-gray-400 uppercase hover:bg-gray-800 rounded-xl transition-all">
                    Cancelar
                </button>
                <button onclick="confirmPublish()"
                    class="flex-[2] py-3 bg-[#4CAF50] hover:bg-green-600 text-[#0f1923] text-xs font-black uppercase rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-sm">cloud_upload</span>
                    Publicar Nova Vers√£o
                </button>
            </div>
        </div>
    </div>

    <div id="fraction-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 p-4">
        <div class="bg-[#1b2227] border border-gray-700 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h3 class="text-white font-black uppercase tracking-tight flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-400">content_cut</span>
                    Fracionar Opera√ß√£o
                </h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <p id="modal-op-name" class="text-sm font-bold text-gray-300 uppercase mb-1">---</p>
                    <p class="text-[10px] text-gray-500 font-bold uppercase">Tempo Unit√°rio: <span
                            id="modal-op-time">0</span>s</p>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-gray-500 tracking-widest">Enviar Fra√ß√£o
                        para:</label>
                    <select id="fraction-target"
                        class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white outline-none focus:border-blue-500 appearance-none font-bold">
                    </select>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between">
                        <label class="text-[10px] font-black uppercase text-gray-500 tracking-widest">Pe√ßas da
                            Fra√ß√£o:</label>
                        <span id="fraction-qty-display" class="text-blue-400 font-black">5</span>
                    </div>
                    <input type="range" id="fraction-slider" min="1" max="10" value="5" oninput="updateFractionUI()"
                        class="w-full h-2 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    <div class="flex justify-between text-[9px] font-bold text-gray-600 uppercase">
                        <span>1 p√ß</span>
                        <span id="fraction-max-label">10 p√ß</span>
                    </div>
                </div>

                <div class="bg-blue-500/10 p-4 rounded-2xl border border-blue-500/20">
                    <p class="text-[10px] font-bold text-blue-400 uppercase mb-1">Carga Movida:</p>
                    <p class="text-xl font-black text-white"><span id="fraction-time-result">0.00</span> <span
                            class="text-xs">min</span></p>
                </div>
            </div>
            <div class="p-6 bg-gray-800/30 flex gap-3">
                <button onclick="closeModal()"
                    class="flex-1 py-3 text-[10px] font-black text-gray-400 uppercase hover:bg-gray-800 rounded-xl transition-all">Cancelar</button>
                <button onclick="confirmFraction()"
                    class="flex-[2] py-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black uppercase rounded-xl shadow-lg transition-all">Confirmar
                    Divis√£o</button>
            </div>
        </div>
    </div>

    <header class="bg-[#1b2227] border-b border-gray-800 p-4 flex justify-between items-center shrink-0 shadow-xl">
        <div class="flex items-center gap-4">
            <span class="material-symbols-outlined text-blue-400">account_tree</span>
            <div>
                <h1 class="text-sm font-black uppercase tracking-tight text-white">Cockpit de Balanceamento</h1>
                <p class="text-[10px] text-gray-500 font-bold uppercase italic tracking-widest">SGP - Motor VAC v2</p>
            </div>
        </div>


        <div class="flex items-center gap-4">
            <div class="flex gap-2">
                <button onclick="resetBalance()"
                    class="bg-red-500/10 hover:bg-red-500/20 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black flex items-center gap-2 transition-all border border-red-500/20">
                    <span class="material-symbols-outlined text-sm">restart_alt</span> RESETAR
                </button>
                <button onclick="openBalance()"
                    class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-xl text-[10px] font-black flex items-center gap-2 transition-all">
                    <span class="material-symbols-outlined text-sm">folder_open</span> ABRIR
                </button>
                <button onclick="loadPublishedBalance()"
                    class="bg-purple-500/10 hover:bg-purple-500/20 text-purple-400 px-4 py-2 rounded-xl text-[10px] font-black flex items-center gap-2 transition-all border border-purple-500/20">
                    <span class="material-symbols-outlined text-sm">download</span> CARREGAR
                </button>
                <button onclick="checkAndSave()"
                    class="bg-[#4CAF50] hover:bg-green-600 text-[#0f1923] px-4 py-2 rounded-xl text-[10px] font-black flex items-center gap-2 shadow-lg">
                    <span class="material-symbols-outlined text-sm">cloud_upload</span> PUBLICAR
                </button>
            </div>

            <div class="h-8 w-px bg-gray-700 mx-2"></div>

            <div class="flex items-center gap-6 bg-gray-900/50 px-4 py-2 rounded-2xl border border-gray-800">
                <div class="flex flex-col">
                    <label class="text-[8px] font-black uppercase text-gray-500">Pulso (Dura√ß√£o)</label>
                    <select id="pulse-select" onchange="updateGlobalParams()"
                        class="bg-transparent text-blue-400 font-black text-sm outline-none cursor-pointer">
                        <option value="30">30 min</option>
                        <option value="60" selected>60 min</option>
                    </select>
                </div>
                <div class="flex flex-col border-l border-gray-800 pl-4">
                    <label class="text-[8px] font-black uppercase text-gray-500">TP Pe√ßa (Ajustado)</label>
                    <p id="tp-display" class="text-white font-black text-sm">11.67 <span class="text-[10px]">min</span>
                    </p>
                </div>
                <div class="flex flex-col border-l border-gray-800 pl-4 bg-blue-500/10 px-3 py-1 rounded-lg">
                    <label class="text-[8px] font-black uppercase text-blue-400">TL (Tamanho do Lote)</label>
                    <p id="tl-display" class="text-blue-400 font-black text-xl leading-none">0</p>
                </div>
            </div>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden">
        <aside class="w-[320px] border-r border-gray-800 bg-[#161d25] flex flex-col shrink-0">
            <div class="p-4 border-b border-gray-800 bg-gray-800/20">
                <h2 class="text-[10px] font-black uppercase text-gray-400 tracking-widest mb-4">Banco de Opera√ß√µes</h2>
                <div class="flex flex-col gap-3">
                    <select id="filter-machine" onchange="renderBank()"
                        class="bg-gray-900 border border-gray-700 rounded-lg p-2 text-[10px] font-bold outline-none text-blue-400">
                        <option value="all">Todas as M√°quinas</option>
                        <option value="over">Overloque</option>
                        <option value="reta">Reta</option>
                        <option value="cobertura">Cobertura</option>
                        <option value="catraca">Catraca</option>
                        <option value="manual">Manual</option>
                    </select>
                    <select id="sort-order" onchange="renderBank()"
                        class="bg-gray-900 border border-gray-700 rounded-lg p-2 text-[10px] font-bold outline-none text-white">
                        <option value="seq">Ordenar por Sequ√™ncia</option>
                        <option value="machine">Ordenar por M√°quina</option>
                    </select>
                </div>
            </div>
            <div id="bank" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar"></div>
        </aside>

        <section id="workstations-container"
            class="flex-1 overflow-x-auto bg-[#0d141b] flex p-4 gap-4 custom-scrollbar"></section>
    </main>

    <script>
        let state = {
            pulseDuration: 60,
            tpAjustado: 0,
            tl: 0,
            activeSeamstresses: [],
            ops: [],
            currentFractionOP: null,
            currentSourceWS: null,
            loadedPsoId: null,
            productReference: null  // Store OP reference for default naming
        };

        const API_URL = "http://localhost:8001/api";

        function resetCockpitState() {
            console.log("üßπ Iniciando limpeza de cache e estado do Cockpit...");
            state.activeSeamstresses = [];
            state.ops = [];
            state.loadedPsoId = null;

            // Limpa o Kanban
            const workstationColumns = document.querySelectorAll('[id^="ws-"]');
            workstationColumns.forEach(col => col.innerHTML = '');

            // Limpa o Banco de Opera√ß√µes
            const bank = document.getElementById('bank');
            if (bank) bank.innerHTML = '';

            // Limpa Labels
            document.getElementById('tp-display').innerHTML = `0.00 <span class="text-[10px]">min</span>`;
            document.getElementById('tl-display').innerText = '0';

            console.log("‚úÖ Cockpit resetado com sucesso.");
        }

        async function loadData(psoId) {
            resetCockpitState(); // Limpa estado anterior

            if (!psoId) {
                console.error('PSO ID is required');
                return;
            }

            try {
                showLoadingState();

                const response = await fetch(`${API_URL}/planning/setup?pso_id=${psoId}`);
                const data = await response.json();

                // Store loaded PSO ID and product reference
                state.loadedPsoId = data.pso.id;
                state.productReference = data.pso.product_reference || `OP-${psoId}`;

                state.activeSeamstresses = data.seamstresses;
                state.ops = data.pso.operations;

                const totalSeconds = state.ops.reduce((sum, op) => sum + op.time, 0);
                state.tpAjustado = totalSeconds / 60;

                document.getElementById('tp-display').innerHTML = `${state.tpAjustado.toFixed(2)} <span class="text-[10px]">min</span>`;

                renderWorkstations();
                calculateTL();
            } catch (error) {
                console.error('Error loading PSO:', error);
                showEmptyState('Erro ao carregar OP. Tente novamente.');
            }
        }

        function showLoadingState() {
            const container = document.getElementById('workstations-container');
            container.innerHTML = `
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <span class="material-symbols-outlined text-6xl text-gray-600 mb-4 block animate-pulse">hourglass_empty</span>
                        <p class="text-gray-400 font-bold">Carregando opera√ß√µes...</p>
                    </div>
                </div>
            `;

            document.getElementById('bank').innerHTML = '';
        }

        function showEmptyState(message = null) {
            const container = document.getElementById('workstations-container');
            container.innerHTML = `
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center max-w-md">
                        <span class="material-symbols-outlined text-8xl text-gray-700 mb-4 block">account_tree</span>
                        <h3 class="text-2xl font-bold text-gray-400 mb-2">Nenhuma OP Carregada</h3>
                        <p class="text-gray-500">${message || 'Clique em "ABRIR" no menu superior para selecionar uma Ordem de Produ√ß√£o e iniciar o balanceamento.'}</p>
                    </div>
                </div>
            `;

            document.getElementById('bank').innerHTML = `
                <div class="text-center py-8">
                    <span class="material-symbols-outlined text-5xl text-gray-700 mb-2 block">inbox</span>
                    <p class="text-gray-500 text-sm">Carregue uma OP para ver as opera√ß√µes</p>
                </div>
            `;


            // Reset metrics
            document.getElementById('tp-display').innerHTML = `0.00 <span class="text-[10px]">min</span>`;
            document.getElementById('tl-display').innerText = '0';
        }

        async function openBalance() {
            try {
                // Fetch available products
                const response = await fetch(`${API_URL}/products`);
                const data = await response.json();
                const products = data.products || [];

                if (products.length === 0) {
                    alert('Nenhuma OP dispon√≠vel no sistema. Importe um PSO primeiro.');
                    return;
                }

                // Create modal HTML
                const modalHTML = `
                    <div id="op-selection-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 p-4" style="backdrop-filter: blur(4px);">
                        <div class="bg-[#1b2227] border border-gray-700 w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden">
                            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                                <h3 class="text-white font-black uppercase tracking-tight flex items-center gap-2">
                                    <span class="material-symbols-outlined text-blue-400">folder_open</span>
                                    Selecionar Ordem de Produ√ß√£o
                                </h3>
                                <button onclick="closeOPModal()" class="text-gray-500 hover:text-white transition-colors">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                            <div class="p-6 max-h-[60vh] overflow-y-auto custom-scrollbar">
                                <div class="grid grid-cols-1 gap-3">
                                    ${products.map(p => `
                                        <button onclick="selectOP(${p.pso_id})" class="text-left bg-gray-900 hover:bg-gray-800 border border-gray-800 hover:border-blue-500 rounded-xl p-4 transition-all group">
                                            <div class="flex justify-between items-start mb-2">
                                                <div>
                                                    <h4 class="text-white font-black text-lg">OP #${p.product_reference}</h4>
                                                    <p class="text-gray-400 text-sm">${p.product_description || 'Sem descri√ß√£o'}</p>
                                                </div>
                                                <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs font-bold rounded">${p.pso_version}</span>
                                            </div>
                                            <div class="flex gap-4 mt-3">
                                                <div class="bg-gray-800/50 px-3 py-2 rounded-lg">
                                                    <p class="text-xs text-gray-500 font-bold uppercase">TP Total</p>
                                                    <p class="text-sm font-black text-blue-400">${p.total_tp_minutes.toFixed(2)} min</p>
                                                </div>
                                                <div class="bg-gray-800/50 px-3 py-2 rounded-lg">
                                                    <p class="text-xs text-gray-500 font-bold uppercase">Opera√ß√µes</p>
                                                    <p class="text-sm font-black text-white">${p.operation_count}</p>
                                                </div>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHTML);

            } catch (error) {
                console.error('Error loading products:', error);
                alert('Erro ao carregar lista de OPs');
            }
        }

        function closeOPModal() {
            const modal = document.getElementById('op-selection-modal');
            if (modal) {
                modal.remove();
            }
        }

        function selectOP(psoId) {
            closeOPModal();
            loadData(psoId);
        }

        async function loadPublishedBalance() {
            try {
                console.log('üîç Buscando balanceamentos publicados...');

                // First, get list of all products with published balances
                const response = await fetch(`${API_URL}/planning/published`);
                const data = await response.json();

                console.log('üì• Resposta da API /planning/published:', data);

                const publishedOPs = data.ops || [];

                if (publishedOPs.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum balanceamento publicado encontrado');
                    alert('Nenhum balanceamento publicado encontrado no sistema.');
                    return;
                }

                // Create modal HTML to select OP and version
                const modalHTML = `
                    <div id="load-balance-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 p-4" style="backdrop-filter: blur(4px);">
                        <div class="bg-[#1b2227] border border-gray-700 w-full max-w-3xl rounded-3xl shadow-2xl overflow-hidden">
                            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                                <h3 class="text-white font-black uppercase tracking-tight flex items-center gap-2">
                                    <span class="material-symbols-outlined text-purple-400">download</span>
                                    Carregar Balanceamento Publicado
                                </h3>
                                <button onclick="closeLoadBalanceModal()" class="text-gray-500 hover:text-white transition-colors">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                            <div class="p-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                                <div class="space-y-4">
                                    ${publishedOPs.map(op => `
                                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <h4 class="text-white font-black text-lg">OP #${op.product_reference}</h4>
                                                    <p class="text-gray-400 text-sm">${op.product_description || 'Sem descri√ß√£o'}</p>
                                                </div>
                                                <span class="px-2 py-1 bg-purple-500/20 text-purple-400 text-xs font-bold rounded">${op.version_count} vers√£o(√µes)</span>
                                            </div>
                                            <div class="space-y-2">
                                                ${op.versions.map(v => `
                                                     <button onclick="loadBalanceVersion(${v.pso_id}, ${v.planning_id})" 
                                                        class="w-full text-left bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-purple-500 rounded-lg p-3 transition-all group">
                                                        <div class="flex justify-between items-center">
                                                            <div class="flex-1">
                                                                <p class="text-white font-bold text-sm">${v.version_name || `Vers√£o ${v.version_number}`}</p>
                                                                <p class="text-xs text-gray-500 mt-1">${v.notes || 'Sem observa√ß√µes'}</p>
                                                            </div>
                                                            <div class="flex items-center gap-3">
                                                                <div class="text-right">
                                                                    <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs font-bold rounded">v${v.version_number}</span>
                                                                    <p class="text-xs text-gray-600 mt-1">${new Date(v.created_at).toLocaleDateString('pt-BR')}</p>
                                                                </div>
                                                                <button onclick="event.stopPropagation(); deleteBalancing(${v.planning_id}, '${v.version_name || `Vers√£o ${v.version_number}`}')" 
                                                                    class="p-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-lg border border-red-500/20 hover:border-red-500/40 transition-all"
                                                                    title="Excluir balanceamento">
                                                                    <span class="material-symbols-outlined text-sm">delete</span>
                                                                </button>
                                                                <span class="material-symbols-outlined text-purple-400 opacity-0 group-hover:opacity-100 transition-opacity">arrow_forward</span>
                                                            </div>
                                                        </div>
                                                        <div class="flex gap-3 mt-2 text-xs">
                                                            <div class="bg-gray-900/50 px-2 py-1 rounded">
                                                                <span class="text-gray-500">Costureiras:</span>
                                                                <span class="text-white font-bold ml-1">${v.seamstress_count}</span>
                                                            </div>
                                                            <div class="bg-gray-900/50 px-2 py-1 rounded">
                                                                <span class="text-gray-500">TL:</span>
                                                                <span class="text-white font-bold ml-1">${v.batch_size}</span>
                                                            </div>
                                                            <div class="bg-gray-900/50 px-2 py-1 rounded">
                                                                <span class="text-gray-500">Pulso:</span>
                                                                <span class="text-white font-bold ml-1">${v.pulse_duration}min</span>
                                                            </div>
                                                        </div>
                                                    </button>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHTML);

            } catch (error) {
                console.error('Error loading published balances:', error);
                alert('Erro ao carregar balanceamentos publicados');
            }
        }

        function closeLoadBalanceModal() {
            const modal = document.getElementById('load-balance-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function loadBalanceVersion(psoId, planningId) {
            try {
                closeLoadBalanceModal();
                showLoadingState();

                // Fetch the specific planning/balance version
                const response = await fetch(`${API_URL}/planning/${planningId}`);
                const data = await response.json();

                // Load the PSO data first
                await loadData(psoId);

                // Then apply the allocations
                state.pulseDuration = data.pulse_duration;
                state.tl = data.batch_size;

                // Update UI
                document.getElementById('pulse-select').value = data.pulse_duration;
                document.getElementById('tl-display').innerText = data.batch_size;

                // Clear all workstations first
                state.activeSeamstresses.forEach((_, i) => {
                    document.getElementById(`ws-${i}`).innerHTML = '';
                });

                // Apply allocations
                data.allocations.forEach(alloc => {
                    const op = state.ops.find(o => o.seq === alloc.operation_seq);
                    if (op) {
                        const wsIndex = state.activeSeamstresses.findIndex(s => s.id === alloc.seamstress_id);
                        if (wsIndex !== -1) {
                            const wsElement = document.getElementById(`ws-${wsIndex}`);
                            const cardHTML = generateCardHTML(op, alloc.is_fraction, alloc.quantity);
                            wsElement.insertAdjacentHTML('beforeend', cardHTML);
                        }
                    }
                });

                // Update calculations
                updateCalculations();
                renderBank();

                alert(`‚úÖ Balanceamento carregado com sucesso!\n\nVers√£o: ${data.version_name || data.version_number}\nPulso: ${data.pulse_duration}min\nTL: ${data.batch_size}`);

            } catch (error) {
                console.error('Error loading balance version:', error);
                alert('Erro ao carregar vers√£o do balanceamento');
                showEmptyState();
            }
        }

        async function deleteBalancing(planningId, versionName) {
            // Confirm deletion
            if (!confirm(`Tem certeza que deseja excluir o balanceamento "${versionName}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }

            try {
                console.log(`üóëÔ∏è Excluindo balanceamento ${planningId}...`);

                const response = await fetch(`${API_URL}/planning/${planningId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);

                    // Close and reopen modal to refresh the list
                    closeLoadBalanceModal();

                    // Small delay to allow modal to close
                    setTimeout(() => {
                        loadPublishedBalance();
                    }, 200);
                } else {
                    alert(`‚ùå Erro ao excluir: ${result.detail || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Error deleting balancing:', error);
                alert(`‚ùå Erro de conex√£o: ${error.message}`);
            }
        }

        function resetBalance() {
            if (!confirm('Tem certeza que deseja resetar o balanceamento? Todas as aloca√ß√µes ser√£o perdidas.')) {
                return;
            }

            state.ops = [];
            state.loadedPsoId = null;
            showEmptyState();
        }

        window.onload = () => {
            // Check if pso_id is in URL
            const urlParams = new URLSearchParams(window.location.search);
            const psoId = urlParams.get('pso_id');

            if (psoId) {
                loadData(psoId);
            } else {
                showEmptyState();
            }
        };

        function calculateTL() {
            if (state.tpAjustado <= 0) {
                state.tl = 0;
                return;
            }
            state.tl = Math.floor((state.activeSeamstresses.length * state.pulseDuration) / state.tpAjustado);
            document.getElementById('tl-display').innerText = state.tl;
            updateCalculations();
            renderBank();
        }

        function renderWorkstations() {
            const container = document.getElementById('workstations-container');
            container.innerHTML = state.activeSeamstresses.map((s, i) => `
                <div class="kanban-column flex flex-col h-full bg-[#1b2227] rounded-2xl border border-gray-800 overflow-hidden shadow-lg">
                    <div class="p-4 bg-gray-800/30 border-b border-gray-800">
                        <div class="text-[11px] font-black text-white uppercase italic mb-3">
                            0${i + 1} - ${s.nome}
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span id="label-ws-${i}" class="text-[9px] font-black uppercase text-gray-400 tracking-tighter">Carga: 0%</span>
                                <span id="time-ws-${i}" class="text-[10px] font-mono font-bold text-blue-400">0.0 min</span>
                            </div>
                            <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden">
                                <div id="bar-ws-${i}" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div id="ws-${i}" class="ws-drop-area flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar"></div>
                </div>
            `).join('');
            setupSortable();
        }

        function renderBank() {
            const bank = document.getElementById('bank');
            const machineFilter = document.getElementById('filter-machine').value;
            const sortBy = document.getElementById('sort-order').value;

            // Pega todos os IDs que j√° est√£o distribu√≠dos nas esta√ß√µes
            const allocatedIds = new Set(
                Array.from(document.querySelectorAll('#workstations-container .op-card'))
                    .map(el => parseInt(el.dataset.id))
            );

            let filteredOps = [...state.ops];

            // Filtra: Remove do banco se j√° estiver alocado
            filteredOps = filteredOps.filter(op => !allocatedIds.has(op.seq));

            if (machineFilter !== 'all') filteredOps = filteredOps.filter(op => op.machine === machineFilter);

            if (sortBy === 'machine') filteredOps.sort((a, b) => a.mName.localeCompare(b.mName));
            else filteredOps.sort((a, b) => a.seq - b.seq);

            bank.innerHTML = filteredOps.map(op => generateCardHTML(op)).join('');
        }

        function generateCardHTML(op, isFraction = false, customQty = null, isOriginal = false) {
            const displayQty = customQty || state.tl;
            const totalTime = ((op.time * displayQty) / 60).toFixed(2);
            let fractionClass = `border-${op.machine}`;
            let label = `#${op.seq}`;

            if (isFraction || isOriginal) {
                fractionClass = 'op-fraction';
                label += isFraction ? ' (FRA√á√ÉO)' : ' (ORIGINAL)';
            }

            return `
                <div data-id="${op.seq}" data-db-id="${op.id}" data-time="${op.time}" data-qty="${displayQty}" data-is-frac="${isFraction || isOriginal}"
                     class="op-card bg-gray-900 p-3 rounded-xl shadow-md cursor-grab active:cursor-grabbing border-gray-800 ${fractionClass}">
                    <div class="flex justify-between mb-1">
                        <span class="text-[9px] font-black text-gray-500 uppercase">${label}</span>
                        <div class="text-right">
                             <p class="text-[9px] font-mono font-bold text-blue-400 leading-none">${op.time}s / p√ß</p>
                             <p class="text-[8px] font-mono text-gray-500 mt-0.5 uppercase">Sub: ${totalTime} min</p>
                        </div>
                    </div>
                    <p class="text-[11px] font-black uppercase text-white mb-1 leading-tight">${op.desc}</p>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">${op.mName}</p>
                        <p class="text-[9px] font-black text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded-full">${displayQty} p√ß</p>
                    </div>
                    <button onclick='openFractionModal(${JSON.stringify(op)}, this)' class="fracionar-btn hidden mt-3 w-full py-2 bg-red-600/10 text-red-500 text-[9px] font-black rounded-lg border border-red-500/20 active:bg-red-600 active:text-white transition-colors">‚úÇÔ∏è FRACIONAR</button>
                    ${isFraction ? `<button onclick='undoFraction(this)' class="mt-2 w-full py-2 bg-gray-700/50 hover:bg-gray-700 text-gray-400 text-[9px] font-black rounded-lg border border-gray-600 transition-colors flex items-center justify-center gap-1"><span class="material-symbols-outlined text-[12px]">undo</span> DESFAZER</button>` : ''}
                </div>
            `;
        }

        function openFractionModal(op, btnElement) {
            state.currentFractionOP = op;
            // Identifica em qual workstation o bot√£o foi clicado
            const sourceWS = btnElement.closest('.ws-drop-area');
            state.currentSourceWSId = sourceWS ? sourceWS.id.replace('ws-', '') : null;

            document.getElementById('modal-op-name').innerText = op.desc;
            document.getElementById('modal-op-time').innerText = op.time;

            const slider = document.getElementById('fraction-slider');
            slider.max = state.tl - 1;
            slider.value = Math.floor(state.tl / 2);
            document.getElementById('fraction-max-label').innerText = (state.tl - 1) + " p√ß";

            // FILTRO: N√£o mostra a costureira atual na lista de destino
            const targetSelect = document.getElementById('fraction-target');
            targetSelect.innerHTML = state.activeSeamstresses
                .filter(s => s.id != state.currentSourceWSId)
                .map(s => `<option value="${s.id}">0${s.id + 1} - ${s.nome}</option>`).join('');

            updateFractionUI();
            document.getElementById('fraction-modal').classList.remove('hidden');
        }

        function confirmFraction() {
            const fractionQty = parseInt(document.getElementById('fraction-slider').value);
            const targetWSIndex = document.getElementById('fraction-target').value;
            const originalQty = state.tl - fractionQty;

            // 1. Localizar o card original na workstation fonte
            const sourceWS = document.getElementById(`ws-${state.currentSourceWSId}`);
            let originalCard = sourceWS.querySelector(`[data-id="${state.currentFractionOP.seq}"]`);

            if (originalCard) {
                // 2. Transforma o original em card fracionado destacado
                originalCard.dataset.qty = originalQty;
                originalCard.dataset.isFrac = "true";
                originalCard.className = originalCard.className.replace(/border-\w+/, 'op-fraction');

                const newTotalTime = ((state.currentFractionOP.time * originalQty) / 60).toFixed(2);
                originalCard.querySelector('.text-right p:last-child').innerText = `Sub: ${newTotalTime} min`;
                originalCard.querySelector('.mt-2 p:last-child').innerText = `${originalQty} p√ß`;
                originalCard.querySelector('.flex span:first-child').innerText = `#${state.currentFractionOP.seq} (ORIGINAL)`;

                // 3. Gerar o novo card de fra√ß√£o na workstation destino
                const targetWS = document.getElementById(`ws-${targetWSIndex}`);
                const fractionHTML = generateCardHTML(state.currentFractionOP, true, fractionQty);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = fractionHTML;
                targetWS.appendChild(tempDiv.firstElementChild);

                updateCalculations();
                closeModal();
            }
        }

        function updateFractionUI() {
            const qty = document.getElementById('fraction-slider').value;
            document.getElementById('fraction-qty-display').innerText = qty;
            const timeResult = (state.currentFractionOP.time * qty) / 60;
            document.getElementById('fraction-time-result').innerText = timeResult.toFixed(2);
        }

        function undoFraction(btnElement) {
            // Get the fraction card that was clicked
            const fractionCard = btnElement.closest('.op-card');
            const opSeq = parseInt(fractionCard.dataset.id);

            // Find ALL cards with this operation sequence across all workstations
            const allCardsWithSameOp = Array.from(document.querySelectorAll(`.op-card[data-id="${opSeq}"]`));

            if (allCardsWithSameOp.length !== 2) {
                console.warn(`Expected 2 cards for operation #${opSeq}, found ${allCardsWithSameOp.length}`);
                // If there's only 1 card, just restore it to normal state
                if (allCardsWithSameOp.length === 1) {
                    const card = allCardsWithSameOp[0];
                    card.dataset.qty = state.tl;
                    card.dataset.isFrac = "false";

                    // Restore original border class based on machine type
                    const op = state.ops.find(o => o.seq === opSeq);
                    if (op) {
                        const machineClass = `border-${op.machine}`;
                        card.className = card.className.replace('op-fraction', machineClass);

                        // Update label to remove (FRA√á√ÉO) or (ORIGINAL)
                        card.querySelector('.flex span:first-child').innerText = `#${opSeq}`;

                        // Update quantities
                        const newTotalTime = ((op.time * state.tl) / 60).toFixed(2);
                        card.querySelector('.text-right p:last-child').innerText = `Sub: ${newTotalTime} min`;
                        card.querySelector('.mt-2 p:last-child').innerText = `${state.tl} p√ß`;

                        // Remove DESFAZER button
                        const undoBtn = card.querySelector('button[onclick*="undoFraction"]');
                        if (undoBtn) undoBtn.remove();
                    }
                }
                updateCalculations();
                renderBank();
                return;
            }

            // Find which is the original and which is the fraction
            // The original should have "(ORIGINAL)" label, fraction has "(FRA√á√ÉO)"
            let originalCard = null;
            let fractionCardToRemove = null;

            allCardsWithSameOp.forEach(card => {
                const label = card.querySelector('.flex span:first-child').innerText;
                if (label.includes('(ORIGINAL)')) {
                    originalCard = card;
                } else if (label.includes('(FRA√á√ÉO)')) {
                    fractionCardToRemove = card;
                }
            });

            // If we can't determine by label, use the clicked card as fraction
            if (!fractionCardToRemove) {
                fractionCardToRemove = fractionCard;
                originalCard = allCardsWithSameOp.find(c => c !== fractionCard);
            }

            if (!originalCard) {
                console.error('Could not find original card for operation #' + opSeq);
                return;
            }

            // Get operation data
            const op = state.ops.find(o => o.seq === opSeq);
            if (!op) {
                console.error('Operation not found in state');
                return;
            }

            // Restore original card to normal state (full TL quantity, no fraction markers)
            originalCard.dataset.qty = state.tl;
            originalCard.dataset.isFrac = "false";

            // Restore original border class based on machine type
            const machineClass = `border-${op.machine}`;
            originalCard.className = originalCard.className.replace('op-fraction', machineClass);

            // Update label to remove (ORIGINAL)
            originalCard.querySelector('.flex span:first-child').innerText = `#${opSeq}`;

            // Update quantities
            const newTotalTime = ((op.time * state.tl) / 60).toFixed(2);
            originalCard.querySelector('.text-right p:last-child').innerText = `Sub: ${newTotalTime} min`;
            originalCard.querySelector('.mt-2 p:last-child').innerText = `${state.tl} p√ß`;

            // Remove DESFAZER button from original card
            const undoBtn = originalCard.querySelector('button[onclick*="undoFraction"]');
            if (undoBtn) undoBtn.remove();

            // Remove the fraction card
            fractionCardToRemove.remove();

            // Update calculations and bank
            updateCalculations();
            renderBank();
        }

        function closeModal() { document.getElementById('fraction-modal').classList.add('hidden'); }

        function resetBalance() {
            if (confirm("Resetar balanceamento? Todas as opera√ß√µes retornar√£o ao banco e fra√ß√µes ser√£o removidas.")) {
                renderBank();
                state.activeSeamstresses.forEach((_, i) => document.getElementById(`ws-${i}`).innerHTML = "");
                updateCalculations();
            }
        }

        function updateCalculations() {
            state.activeSeamstresses.forEach((_, i) => {
                const ws = document.getElementById(`ws-${i}`);
                const cards = Array.from(ws.querySelectorAll('.op-card'));
                const bank = document.getElementById('bank');

                // Limpeza: Cards no banco nunca mostram fracionar e perdem status de fra√ß√£o se resetados
                Array.from(bank.querySelectorAll('.op-card')).forEach(c => {
                    c.querySelector('.fracionar-btn').classList.add('hidden');
                });

                const totalMinutes = cards.reduce((sum, card) => {
                    return sum + ((parseFloat(card.dataset.time) * parseFloat(card.dataset.qty)) / 60);
                }, 0);

                const percent = (totalMinutes / state.pulseDuration) * 100;
                document.getElementById(`time-ws-${i}`).innerText = `${totalMinutes.toFixed(1)} min`;
                document.getElementById(`label-ws-${i}`).innerText = `Carga: ${percent.toFixed(0)}%`;

                const bar = document.getElementById(`bar-ws-${i}`);
                bar.style.width = `${Math.min(percent, 100)}%`;

                if (totalMinutes > state.pulseDuration) {
                    bar.className = "h-full bg-red-600";
                    cards.forEach(c => {
                        // S√≥ permite fracionar se N√ÉO for um card que j√° √© resultado de uma fra√ß√£o
                        if (c.dataset.isFrac !== "true") c.querySelector('.fracionar-btn').classList.remove('hidden');
                    });
                } else {
                    bar.className = totalMinutes >= (state.pulseDuration - 5) ? "h-full bg-[#4CAF50]" : "h-full bg-yellow-500";
                    cards.forEach(c => c.querySelector('.fracionar-btn').classList.add('hidden'));
                }
            });
        }

        function setupSortable() {
            const areas = [document.getElementById('bank'), ...state.activeSeamstresses.map((_, i) => document.getElementById(`ws-${i}`))];
            areas.forEach(el => new Sortable(el, { group: 'balance', animation: 150, onEnd: updateCalculations }));
        }

        function updateGlobalParams() {
            state.pulseDuration = parseInt(document.getElementById('pulse-select').value);
            calculateTL();
        }


        async function checkAndSave() {
            if (!state.loadedPsoId) {
                alert('Nenhuma OP carregada. Abra uma OP primeiro.');
                return;
            }

            // Check if there are any allocations
            const hasAllocations = state.activeSeamstresses.some((_, index) => {
                const wsElement = document.getElementById(`ws-${index}`);
                return wsElement && wsElement.querySelectorAll('.op-card').length > 0;
            });

            if (!hasAllocations) {
                alert('N√£o h√° opera√ß√µes alocadas. Distribua as opera√ß√µes antes de publicar.');
                return;
            }

            // Open version management modal
            await openVersionModal();
        }

        async function openVersionModal() {
            try {
                // Fetch existing versions for this PSO
                const response = await fetch(`${API_URL}/planning/versions?pso_id=${state.loadedPsoId}`);
                const data = await response.json();
                const versions = data.versions || [];

                const versionsContainer = document.getElementById('existing-versions');

                if (versions.length === 0) {
                    versionsContainer.innerHTML = `
                        <div class="text-center py-6 bg-gray-900/50 rounded-lg border border-gray-800">
                            <span class="material-symbols-outlined text-4xl text-gray-600 mb-2 block">inventory_2</span>
                            <p class="text-gray-500 text-sm">Nenhuma vers√£o publicada ainda</p>
                            <p class="text-gray-600 text-xs mt-1">Esta ser√° a primeira vers√£o</p>
                        </div>
                    `;
                } else {
                    versionsContainer.innerHTML = versions.map((v, idx) => `
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 hover:border-blue-500/50 transition-all">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h5 class="text-white font-bold text-sm">${v.version_name || `Vers√£o ${idx + 1}`}</h5>
                                    <p class="text-xs text-gray-500 mt-1">${v.notes || 'Sem observa√ß√µes'}</p>
                                </div>
                                <div class="text-right">
                                    <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs font-bold rounded">v${v.version_number}</span>
                                    <p class="text-xs text-gray-600 mt-1">${new Date(v.created_at).toLocaleDateString('pt-BR')}</p>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-3 text-xs">
                                <div class="bg-gray-800/50 px-2 py-1 rounded">
                                    <span class="text-gray-500">Costureiras:</span>
                                    <span class="text-white font-bold ml-1">${v.seamstress_count}</span>
                                </div>
                                <div class="bg-gray-800/50 px-2 py-1 rounded">
                                    <span class="text-gray-500">TL:</span>
                                    <span class="text-white font-bold ml-1">${v.batch_size}</span>
                                </div>
                                <div class="bg-gray-800/50 px-2 py-1 rounded">
                                    <span class="text-gray-500">Pulso:</span>
                                    <span class="text-white font-bold ml-1">${v.pulse_duration}min</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Show modal
                document.getElementById('version-modal').classList.remove('hidden');

                // Set default version name to #OP format
                const versionNameInput = document.getElementById('version-name');
                if (state.productReference) {
                    versionNameInput.placeholder = `#${state.productReference}`;
                }

            } catch (error) {
                console.error('Error loading versions:', error);
                alert('Erro ao carregar vers√µes existentes. Continuando com publica√ß√£o...');
                // If error, proceed with save anyway
                await saveBalancing();
            }
        }

        function closeVersionModal() {
            document.getElementById('version-modal').classList.add('hidden');
            document.getElementById('version-name').value = '';
            document.getElementById('version-notes').value = '';
        }

        async function confirmPublish() {
            const versionName = document.getElementById('version-name').value.trim();
            const versionNotes = document.getElementById('version-notes').value.trim();

            // Use product reference as default if no name provided
            const finalVersionName = versionName || state.productReference || 'Vers√£o sem nome';

            closeVersionModal();
            await saveBalancing(finalVersionName, versionNotes);
        }

        function checkAndSave() {
            // Validate if there's a PSO loaded
            if (!state.loadedPsoId) {
                alert('‚ö†Ô∏è Nenhuma OP carregada! Abra uma OP antes de publicar.');
                return;
            }

            // Check if there are any allocated operations
            let hasAllocations = false;
            state.activeSeamstresses.forEach((seamstress, index) => {
                const wsElement = document.getElementById(`ws-${index}`);
                const cards = wsElement.querySelectorAll('.op-card');
                if (cards.length > 0) {
                    hasAllocations = true;
                }
            });

            if (!hasAllocations) {
                alert('‚ö†Ô∏è Nenhuma opera√ß√£o foi alocada! Distribua opera√ß√µes nas costureiras antes de publicar.');
                return;
            }

            // Prompt for version name and notes
            const versionName = prompt('üìù Nome do balanceamento:', `Bal_${state.productReference || 'versao'}`);

            if (versionName === null) {
                // User cancelled
                return;
            }

            const versionNotes = prompt('üìã Observa√ß√µes (opcional):');

            // Save with provided name and notes
            saveBalancing(versionName.trim() || state.productReference, versionNotes ? versionNotes.trim() : '');
        }

        async function saveBalancing(versionName = '', versionNotes = '') {
            const allocations = [];

            state.activeSeamstresses.forEach((seamstress, index) => {
                const wsElement = document.getElementById(`ws-${index}`);
                const cards = Array.from(wsElement.querySelectorAll('.op-card'));

                cards.forEach((card, pos) => {
                    const dbId = card.dataset.dbId;
                    if (!dbId) {
                        console.warn("Card sem DB ID encontrado. Ignorando.", card);
                        return;
                    }
                    allocations.push({
                        operation_id: parseInt(dbId),
                        workstation_id: seamstress.id,
                        position: pos + 1,
                        quantity: parseInt(card.dataset.qty),
                        is_fraction: card.dataset.isFrac === "true"  // ‚úÖ Pass fractioning info to backend
                    });
                });
            });

            const payload = {
                pso_id: state.loadedPsoId,
                pulse_duration: state.pulseDuration,
                batch_size: state.tl,
                allocations: allocations,
                version_name: versionName,  // Always send, even if empty
                notes: versionNotes || null
            };

            console.log('üì§ Publicando balanceamento:', payload);

            try {
                const response = await fetch(`${API_URL}/planning/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('üì• Resposta da API:', result);

                if (response.ok) {
                    alert(`‚úÖ Balanceamento publicado com sucesso!\n\nID do Planejamento: ${result.planning_id}\nVers√£o: ${versionName}\nPulso: ${state.pulseDuration} min\nTL: ${state.tl}`);
                } else {
                    alert(`‚ùå Erro ao publicar: ${result.detail || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Save Error:', error);
                alert(`‚ùå Erro de conex√£o: ${error.message}`);
            }
        }
    </script>
</body>

</html>